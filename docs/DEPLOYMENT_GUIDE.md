# Deployment Guide

## Server Requirements

### Minimum Requirements
- **PHP**: 8.1 or higher
- **MySQL**: 5.7 or higher (8.0 recommended)
- **Web Server**: Apache 2.4+ or Nginx 1.18+
- **Composer**: 2.x
- **Node.js**: 16.x or higher (for asset compilation)
- **Memory**: 512MB minimum (2GB recommended)
- **Disk Space**: 10GB minimum

### PHP Extensions Required
```
- BCMath
- Ctype
- Fileinfo
- JSON
- Mbstring
- OpenSSL
- PDO
- PDO_MySQL
- Tokenizer
- XML
- cURL
- GD or Imagick
- Zip
- IMAP
```

---

## Installation Steps

### 1. Clone Repository
```bash
cd /var/www
git clone <repository-url> elitemail
cd elitemail
```

### 2. Install Dependencies
```bash
# Install PHP dependencies
composer install --optimize-autoloader --no-dev

# Install Node dependencies
npm install

# Build assets
npm run build
```

### 3. Environment Configuration
```bash
# Copy environment file
cp .env.example .env

# Generate application key
php artisan key:generate
```

### 4. Configure Environment Variables
Edit `.env` file:

```env
# Application
APP_NAME="Elite Mail"
APP_ENV=production
APP_KEY=base64:... # Generated by key:generate
APP_DEBUG=false
APP_URL=https://yourdomain.com

# Database
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=elitemail
DB_USERNAME=dbuser
DB_PASSWORD=securepassword

# Chargebee
CHARGEBEE_SITE=your-site
CHARGEBEE_API_KEY=your-api-key

# Mail
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=your-username
MAIL_PASSWORD=your-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@yourdomain.com
MAIL_FROM_NAME="${APP_NAME}"

# IMAP (Support Tickets)
IMAP_HOST=imap.gmail.com
IMAP_PORT=993
IMAP_ENCRYPTION=ssl
IMAP_VALIDATE_CERT=true
IMAP_USERNAME=support@yourdomain.com
IMAP_PASSWORD=your-password

# Queue
QUEUE_CONNECTION=database

# Session
SESSION_DRIVER=file
SESSION_LIFETIME=120

# Cache
CACHE_DRIVER=file
```

### 5. Database Setup
```bash
# Create database
mysql -u root -p
CREATE DATABASE elitemail CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'dbuser'@'localhost' IDENTIFIED BY 'securepassword';
GRANT ALL PRIVILEGES ON elitemail.* TO 'dbuser'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# Run migrations
php artisan migrate --force

# Seed database (optional)
php artisan db:seed
```

### 6. Set Permissions
```bash
# Set ownership
chown -R www-data:www-data /var/www/elitemail

# Set permissions
chmod -R 755 /var/www/elitemail
chmod -R 775 /var/www/elitemail/storage
chmod -R 775 /var/www/elitemail/bootstrap/cache
```

### 7. Configure Web Server

#### Apache Configuration
```apache
<VirtualHost *:80>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    DocumentRoot /var/www/elitemail/public

    <Directory /var/www/elitemail/public>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/elitemail-error.log
    CustomLog ${APACHE_LOG_DIR}/elitemail-access.log combined
</VirtualHost>
```

#### Nginx Configuration
```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    root /var/www/elitemail/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

### 8. SSL Certificate (Let's Encrypt)
```bash
# Install Certbot
apt-get install certbot python3-certbot-apache  # For Apache
# OR
apt-get install certbot python3-certbot-nginx   # For Nginx

# Obtain certificate
certbot --apache -d yourdomain.com -d www.yourdomain.com  # Apache
# OR
certbot --nginx -d yourdomain.com -d www.yourdomain.com   # Nginx

# Auto-renewal
certbot renew --dry-run
```

### 9. Optimize Application
```bash
# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache

# Optimize autoloader
composer dump-autoload --optimize
```

---

## Cron Job Setup

### Add to Crontab
```bash
crontab -e
```

Add the following line:
```cron
* * * * * cd /var/www/elitemail && php artisan schedule:run >> /dev/null 2>&1
```

This runs Laravel's scheduler every minute, which then executes scheduled tasks.

### Verify Cron Jobs
```bash
# Check scheduled tasks
php artisan schedule:list

# Test specific command
php artisan panel:check-capacity
```

---

## Queue Worker Setup

### Using Supervisor (Recommended)

#### Install Supervisor
```bash
apt-get install supervisor
```

#### Create Configuration
Create `/etc/supervisor/conf.d/elitemail-worker.conf`:

```ini
[program:elitemail-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/elitemail/artisan queue:work database --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=4
redirect_stderr=true
stdout_logfile=/var/www/elitemail/storage/logs/worker.log
stopwaitsecs=3600
```

#### Start Supervisor
```bash
# Reload configuration
supervisorctl reread
supervisorctl update

# Start workers
supervisorctl start elitemail-worker:*

# Check status
supervisorctl status
```

### Alternative: Systemd Service
Create `/etc/systemd/system/elitemail-queue.service`:

```ini
[Unit]
Description=Elite Mail Queue Worker
After=network.target

[Service]
User=www-data
Group=www-data
Restart=always
ExecStart=/usr/bin/php /var/www/elitemail/artisan queue:work database --sleep=3 --tries=3

[Install]
WantedBy=multi-user.target
```

Enable and start:
```bash
systemctl enable elitemail-queue
systemctl start elitemail-queue
systemctl status elitemail-queue
```

---

## Backup Configuration

### Database Backup Script
Create `/usr/local/bin/backup-elitemail.sh`:

```bash
#!/bin/bash

# Configuration
DB_NAME="elitemail"
DB_USER="dbuser"
DB_PASS="securepassword"
BACKUP_DIR="/var/backups/elitemail"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# Create backup directory
mkdir -p $BACKUP_DIR

# Backup database
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/db_backup_$DATE.sql.gz

# Backup storage directory
tar -czf $BACKUP_DIR/storage_backup_$DATE.tar.gz /var/www/elitemail/storage

# Delete old backups
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +$RETENTION_DAYS -delete
find $BACKUP_DIR -name "storage_backup_*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: $DATE"
```

Make executable:
```bash
chmod +x /usr/local/bin/backup-elitemail.sh
```

Add to crontab (daily at 3 AM):
```cron
0 3 * * * /usr/local/bin/backup-elitemail.sh >> /var/log/elitemail-backup.log 2>&1
```

---

## Security Hardening

### 1. Disable Directory Listing
Apache: Add to `.htaccess`:
```apache
Options -Indexes
```

Nginx: Already disabled by default

### 2. Hide PHP Version
Edit `php.ini`:
```ini
expose_php = Off
```

### 3. Set Secure Headers
Add to web server configuration:
```
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000; includeSubDomains
```

### 4. Configure Firewall
```bash
# UFW (Ubuntu)
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable

# Fail2Ban
apt-get install fail2ban
systemctl enable fail2ban
systemctl start fail2ban
```

### 5. Secure MySQL
```bash
mysql_secure_installation
```

### 6. Regular Updates
```bash
# System updates
apt-get update && apt-get upgrade

# Composer updates
composer update

# Check for security vulnerabilities
composer audit
```

---

## Monitoring & Logging

### Log Files
- **Laravel Logs**: `/var/www/elitemail/storage/logs/laravel.log`
- **Web Server Logs**: `/var/log/apache2/` or `/var/log/nginx/`
- **Queue Worker Logs**: `/var/www/elitemail/storage/logs/worker.log`
- **Cron Logs**: Check syslog or custom log files

### Log Rotation
Create `/etc/logrotate.d/elitemail`:

```
/var/www/elitemail/storage/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
}
```

### Monitoring Tools
- **Laravel Telescope** (Development only)
- **Laravel Horizon** (Queue monitoring)
- **New Relic** or **DataDog** (APM)
- **Sentry** (Error tracking)

---

## Troubleshooting

### Common Issues

#### 1. Permission Errors
```bash
chown -R www-data:www-data /var/www/elitemail
chmod -R 775 /var/www/elitemail/storage
chmod -R 775 /var/www/elitemail/bootstrap/cache
```

#### 2. Queue Not Processing
```bash
# Check queue worker status
supervisorctl status

# Restart workers
supervisorctl restart elitemail-worker:*

# Check for failed jobs
php artisan queue:failed
```

#### 3. Database Connection Errors
- Verify `.env` database credentials
- Check MySQL service: `systemctl status mysql`
- Test connection: `mysql -u dbuser -p`

#### 4. 500 Internal Server Error
```bash
# Check Laravel logs
tail -f /var/www/elitemail/storage/logs/laravel.log

# Check web server logs
tail -f /var/log/apache2/error.log  # Apache
tail -f /var/log/nginx/error.log    # Nginx

# Enable debug mode temporarily
# Edit .env: APP_DEBUG=true
# Clear cache: php artisan config:clear
```

#### 5. IMAP Connection Issues
- Verify IMAP credentials in `.env`
- Check firewall allows outbound IMAP ports
- Test IMAP connection manually
- Enable less secure apps (Gmail)

---

## Performance Optimization

### 1. Enable OPcache
Edit `php.ini`:
```ini
opcache.enable=1
opcache.memory_consumption=256
opcache.interned_strings_buffer=16
opcache.max_accelerated_files=10000
opcache.revalidate_freq=2
```

### 2. Use Redis for Cache & Sessions
```bash
# Install Redis
apt-get install redis-server

# Install PHP Redis extension
pecl install redis
```

Update `.env`:
```env
CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
```

### 3. Database Optimization
```sql
-- Add indexes for frequently queried columns
CREATE INDEX idx_orders_user_status ON orders(user_id, status);
CREATE INDEX idx_orders_assigned ON orders(assigned_to, status);
CREATE INDEX idx_pools_user_status ON pools(user_id, status);

-- Optimize tables
OPTIMIZE TABLE orders;
OPTIMIZE TABLE pools;
OPTIMIZE TABLE order_emails;
```

### 4. CDN for Static Assets
- Use CloudFlare or AWS CloudFront
- Configure asset URLs in `.env`

---

## Scaling Considerations

### Horizontal Scaling
1. **Load Balancer**: Nginx or HAProxy
2. **Multiple App Servers**: Shared storage for sessions
3. **Separate Database Server**: MySQL replication
4. **Separate Queue Workers**: Dedicated queue servers
5. **Redis Cluster**: For cache and sessions

### Vertical Scaling
- Increase server resources (CPU, RAM)
- Optimize database queries
- Use database read replicas
- Implement caching strategies

---

*Continue to [API_DOCUMENTATION.md](./API_DOCUMENTATION.md) for webhook and endpoint reference.*
